<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Force reload pathogen grids data -->
    <meta name="pathogen-grids-version" content="20250627110000">
    <title>PCR Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="/static/pathogen_library.js"></script>
    <link rel="stylesheet" href="/static/style.css?v=1735174000">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üß¨ MDL PCR Analyzer</h1>
            <p>Upload your CFX Manager CSV file to analyze amplification curves with flexible cycle counts</p>
            <div class="features">
                <span class="feature">‚úì Variable Cycle Lengths</span>
                <span class="feature">‚úì Dynamic Curve Fitting</span>
                <span class="feature">‚úì Real-time Analysis</span>
            </div>
        </div>

        <div class="upload-section">
            <div class="instructions-box">
                <h3>üìã Upload Instructions</h3>
                <p><strong>CFX Manager Export:</strong> Open .pcrd ‚Üí Quantification tab ‚Üí Export All Data Sheets ‚Üí CSV Format</p>
                <p><strong>Multi-Channel Support:</strong> Upload multiple "Quantification Amplification Results" CSV files - one for each fluorophore (Cy5, FAM, HEX, Texas Red) with pattern: testName_1234567_CFX123456.csv</p>
                <p><strong>Cycle Threshold Comparison:</strong> Upload the "Quantification Summary" CSV file for cycle threshold comparison (Required) - system automatically matches wells and fluorophores to display correct sample names and Cq values</p>
                <p><strong>Smart Analysis:</strong> System analyzes all uploaded fluorophores simultaneously for comprehensive multi-channel results</p>
            </div>
            
            <div class="file-upload-multi" id="fileUpload">
                <div class="upload-icon">üìÅ</div>
                <h3>Upload qPCR Data Files</h3>
                <p>Upload amplification data and optionally integrate Cq values and sample names</p>
                
                <div class="file-upload-grid">
                    <div class="upload-item primary">
                        <h4>1. Amplification Data (Required)</h4>
                        <p>Upload one or more fluorophore-specific CSV files (Cy5, FAM, HEX, Texas Red)</p>
                        <input type="file" id="fileInput" class="file-input" accept=".csv" multiple>
                        <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                            Choose matching Amplification CSV Files
                        </button>
                        <button class="clear-btn" onclick="clearAmplificationFiles()">Clear Files</button>
                        <div class="file-status" id="amplificationStatus"></div>
                        <div class="uploaded-files" id="uploadedFiles"></div>
                    </div>
                    
                    <div class="upload-item required">
                        <h4>2. Quantification Summary (Required)</h4>
                        <p>Upload the Summary CSV file - provides sample names and Cq values for analysis</p>
                        <input type="file" id="samplesInput" class="file-input" accept=".csv">
                        <button class="upload-btn" onclick="document.getElementById('samplesInput').click()">
                            Choose a matching Quantification Summary
                        </button>
                        <button class="clear-btn" onclick="clearSummaryFile()">Clear File</button>
                        <div class="file-status" id="samplesStatus"></div>
                    </div>
                </div>
            </div>
            
            <div class="file-info" id="fileInfo" style="display: none;">
                <div class="file-details">
                    <strong>File:</strong> <span id="fileName"></span><br>
                    <strong>Size:</strong> <span id="fileSize"></span><br>
                    <strong>Cycles Detected:</strong> <span id="cycleRange"></span><br>
                    <strong>Wells Found:</strong> <span id="wellCount"></span>
                </div>
                <button class="analyze-btn" id="analyzeBtn">Analyze Curves</button>
            </div>
        </div>

        <div class="analysis-section" id="analysisSection" style="display: none;">
            <div class="controls">
                <div class="fluorophore-selector">
                    <label for="fluorophoreSelect">Select Fluorophore:</label>
                    <select id="fluorophoreSelect">
                        <option value="all">All Fluorophores</option>
                    </select>
                </div>
                <div class="well-selector">
                    <label for="wellSelect">Select Well:</label>
                    <select id="wellSelect"></select>
                </div>
                <div class="view-controls">
                    <button class="control-btn" id="showSelectedBtn">Show Selected Curve</button>
                    <button class="control-btn" id="showAllBtn">Show All Wells</button>
                    <button class="control-btn pos-btn" id="showPosBtn">POS</button>
                    <button class="control-btn neg-btn" id="showNegBtn">NEG</button>
                    <button class="control-btn redo-btn" id="showRedoBtn">REDO</button>
                    <button class="control-btn" id="exportBtn">Export Results</button>
                </div>
            </div>

            <div class="chart-container">
                <canvas id="amplificationChart"></canvas>
            </div>

            <div class="results-sections-container">
                <div class="analysis-summary-section">
                    <div class="results-summary">
                        <h3>Analysis Summary</h3>
                        <div class="summary-stats">
                            <div class="stat-item">
                                <span class="stat-label">Experiment Name:</span>
                                <span class="stat-value" id="experimentPattern">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Cycle Range:</span>
                                <span class="stat-value" id="cycleRangeResult">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Total Positive:</span>
                                <span class="stat-value" id="totalPositive">-</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Positive Percentage:</span>
                                <span class="stat-value" id="positivePercentage">-</span>
                            </div>
                            <div class="control-validation-grid" id="controlValidationGrid" style="display: none;">
                                <div class="control-grid-header">
                                    <span class="control-grid-label">Control Validation:</span>
                                </div>
                                <div class="control-grid">
                                    <div class="control-grid-axis">
                                        <div class="control-grid-corner"></div>
                                        <div class="control-set-header">1</div>
                                        <div class="control-set-header">2</div>
                                        <div class="control-set-header">3</div>
                                        <div class="control-set-header">4</div>
                                    </div>
                                    <div class="control-type-row">
                                        <div class="control-type-label">H</div>
                                        <div class="control-cell" id="controlH1">-</div>
                                        <div class="control-cell" id="controlH2">-</div>
                                        <div class="control-cell" id="controlH3">-</div>
                                        <div class="control-cell" id="controlH4">-</div>
                                    </div>
                                    <div class="control-type-row">
                                        <div class="control-type-label">M</div>
                                        <div class="control-cell" id="controlM1">-</div>
                                        <div class="control-cell" id="controlM2">-</div>
                                        <div class="control-cell" id="controlM3">-</div>
                                        <div class="control-cell" id="controlM4">-</div>
                                    </div>
                                    <div class="control-type-row">
                                        <div class="control-type-label">L</div>
                                        <div class="control-cell" id="controlL1">-</div>
                                        <div class="control-cell" id="controlL2">-</div>
                                        <div class="control-cell" id="controlL3">-</div>
                                        <div class="control-cell" id="controlL4">-</div>
                                    </div>
                                    <div class="control-type-row">
                                        <div class="control-type-label">NTC</div>
                                        <div class="control-cell" id="controlNTC1">-</div>
                                        <div class="control-cell" id="controlNTC2">-</div>
                                        <div class="control-cell" id="controlNTC3">-</div>
                                        <div class="control-cell" id="controlNTC4">-</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="fluorophore-breakdown" id="fluorophoreBreakdown">
                            <!-- Fluorophore-specific statistics will be populated here -->
                        </div>
                        

                        
                        <!-- Pathogen grids section for new system -->
                        <div id="pathogen-grids-section">
                            <!-- Pathogen-specific control validation grids will be added here -->
                        </div>
                        
                        <div class="channel-completion-status" id="channelCompletionStatus" style="display: none;">
                            <!-- Channel completion status will be populated here -->
                        </div>
                    </div>
                </div>



                <div class="curve-details-section">
                    <div class="curve-details">
                        <h3>Selected Curve Details</h3>
                        <div class="details-content" id="curveDetails">
                            <p>Select a well to view detailed analysis results</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Manual Pathogen Grids Button - Hidden (automatic approach implemented) -->
            <div id="pathogenGridsManual" style="display: none; margin: 20px 0; text-align: center; background: #f0f0f0; padding: 20px; border: 2px solid #2196F3; border-radius: 8px;">
                <button onclick="generatePathogenGridsManually()" style="background: #2196F3 !important; color: white !important; padding: 15px 30px !important; border: none !important; border-radius: 8px !important; cursor: pointer !important; font-size: 18px !important; font-weight: bold !important;">
                    üî¨ Generate Pathogen Control Grids
                </button>
                <p style="margin: 10px 0 0 0; color: #333; font-size: 16px; font-weight: bold;">Click to generate pathogen-specific control validation grids</p>
            </div>

            <div class="wells-table-container">
                <h3 id="wellsAnalysisTitle">All Wells Analysis</h3>
                <div class="table-controls">
                    <input type="text" id="searchWells" placeholder="Search wells..." class="search-input">
                    <select id="filterStatus" class="filter-select">
                        <option value="all">All Wells</option>
                        <option value="pos">POS Results</option>
                        <option value="neg">NEG Results</option>
                        <option value="redo">REDO Results</option>
                        <option value="controls">Controls</option>
                    </select>
                </div>
                <div class="table-wrapper">
                    <table id="resultsTable">
                        <thead>
                            <tr>
                                <th>Well</th>
                                <th>Sample Name</th>
                                <th>Fluorophore</th>
                                <th>Results</th>
                                <th>Status</th>
                                <th>R¬≤ Score</th>
                                <th>RMSE</th>
                                <th>Amplitude</th>
                                <th>Steepness</th>
                                <th>Midpoint</th>
                                <th>Baseline</th>
                                <th>Cq Value</th>
                                <th>Anomalies</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="history-section" id="historySection">
            <div class="history-header">
                <h2>Analysis History</h2>
                <div class="history-controls" style="margin-top: 15px;">
                    <button class="control-btn trend-btn" id="trendAnalysisBtn" onclick="viewTrendAnalysis()">View Trends</button>
                </div>
            </div>
            
            <div class="history-content" id="historyContent">
                <p>Loading analysis history...</p>
            </div>
        </div>



        <div class="loading" id="loadingIndicator" style="display: none;">
            <div class="spinner"></div>
            <p>Analyzing curves...</p>
        </div>

        <!-- Chart Modal -->
        <div class="modal" id="chartModal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-navigation">
                        <button class="modal-nav-btn" id="modalPrevBtn" disabled>‚Üê Previous</button>
                        <h3 id="modalTitle">qPCR Amplification Curve</h3>
                        <button class="modal-nav-btn" id="modalNextBtn" disabled>Next ‚Üí</button>
                    </div>
                    <span class="modal-close" id="modalClose">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="modal-chart-container">
                        <canvas id="modalChart"></canvas>
                    </div>
                    <div class="modal-details" id="modalDetails">
                        <!-- Sample details will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Removed unused pathogen_grids.js - tab functionality handled by script.js + pathogen_grids_data.js -->
    <script src="/static/pathogen_grids_data.js?v=20250627120000&t=1751034600"></script>
    <script src="/static/script.js?v=20250627120000&t=1751034600"></script>
</body>
</html>
